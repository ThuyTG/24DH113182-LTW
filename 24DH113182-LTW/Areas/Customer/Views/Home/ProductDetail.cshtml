@model _24DH113182_LTW.Models.ViewModel.ProductDetailVM
@{
    ViewBag.Title = "Chi tiết sản phẩm";
    Layout = "~/Areas/Customer/Views/Shared/_CustomerLayout.cshtml";
}

<link rel="stylesheet" type="text/css" href="~/Content/myStyle/CustomerHome.css"/>

<div class="container-fluid pro">
    <div class="div-horizontal row">
        @*Khối bên trái *@
            @*Hình ảnh sản phẩm*@
        <div class="col-md-3 pro-section">
            <img src="@Model.product.ProductImage"/>
        </div>

        @*Khối ở giữa*@
        <div class="col-md-5 pro-section">
            @*Thông tin sản phẩm*@
            <div>
                <h4><strong>@Html.DisplayFor(model => model.product.ProductName)</strong></h4>
                <p class="pro-sale">Đã bán: &nbsp; @Model.product.OrderDetails.Count</p>
                <p class="pro-price">@Model.product.ProductPrice</p>
                <p>Tủ sách: &nbsp; @Model.product.Category.CategoryName</p>
                <hr />
                <h5><strong>Mô tả</strong></h5>
                <p>@Model.product.ProductDescription</p>
            </div>
            <hr />
            @*Related Products*@
            <div>@Html.Partial("_PVRelatedProduct", Model)</div>
        </div>

        @*Khối bên phải*@
            @*Phần tạm tính*@
        <div class="col-md-3 pro-section">
            <div class="form-group">
                @using (Html.BeginForm("ProductDetail", "Home", FormMethod.Post))
                {
                    <h4><strong>Số lượng</strong></h4>
                    <p>
                        @Html.TextBoxFor(model => model.quantity, new { @class = "form-control", @type = "number", @min = 1})
                    </p>

                    <h4><strong>Tạm tính</strong></h4>
                    <p>@Model.estimatedValue.ToString("N0")</p>
                    <p>
                        @Html.ActionLink("Thêm vào giỏ hàng", "AddToCart", "Cart",
                        new {id = Model.product.ProductID, quantity = Model.quantity},
                        new {@class = "btn btn-info"})
                    </p>
                }
                <hr/>
            </div>
        </div>

        @*Khối Top product *@
        <div>@Html.Partial("_PVTopProduct", Model)</div>
    </div>
</div>
@section Scripts{
    
    <script>
    (function () {
            // Elements
            var qtyInput = document.getElementById('quantityInput');
            var estimatedEl = document.getElementById('estimatedValue');
            var priceEl = document.querySelector('.pro-price');
            var addToCartBtn = document.getElementById('addToCartBtn');

            if (!qtyInput || !estimatedEl || !priceEl || !addToCartBtn) return;

            // Read raw numeric price from data attribute; fallback to parsing displayed text
            var priceRaw = parseFloat(priceEl.getAttribute('data-price'));
            if (isNaN(priceRaw)) {
                // remove non-digits and parse
                priceRaw = parseFloat(priceEl.textContent.replace(/[^\d.-]/g, '')) || 0;
            }

            // Helper: format as integer with thousand separators (no decimals) to match server "N0"
            function formatNumberNoDecimals(n) {
                return Math.round(n).toLocaleString('vi-VN');
            }

            // Update estimated and AddToCart href
            function updateEstimated() {
                var qty = parseInt(qtyInput.value, 10) || 1;
                if (qty < 1) { qty = 1; qtyInput.value = 1; }
                var estimated = priceRaw * qty;
                estimatedEl.textContent = formatNumberNoDecimals(estimated);

                // Update AddToCart link href: keep id param, replace quantity
                // Build base url from existing href without quantity param
                try {
                    var url = new URL(addToCartBtn.href, window.location.origin);
                    url.searchParams.set('quantity', qty);
                    addToCartBtn.href = url.toString();
                } catch (e) {
                    // Fallback: append/replace quantity parameter manually
                    var href = addToCartBtn.getAttribute('href') || '';
                    // remove existing quantity param
                    href = href.replace(/([?&])quantity=\d+(&?)/, function (m, p1, p2) { return p2 ? p1 : ''; });
                    var sep = href.indexOf('?') === -1 ? '?' : '&';
                    addToCartBtn.setAttribute('href', href + sep + 'quantity=' + qty);
                }
            }

            // initialize on load
            updateEstimated();

            // update on input change
            qtyInput.addEventListener('input', updateEstimated);
            qtyInput.addEventListener('change', updateEstimated);
        })();</script>    
}
